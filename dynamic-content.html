<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ResetRx Content</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
            padding: 0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Container optimized for mobile */
        .page-container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
        }

        .content-wrapper {
            padding: 20px 16px;
        }

        /* Hero Header - optimized for mobile */
        .hero-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 32px 20px 28px;
            position: relative;
            overflow: hidden;
        }

        .hero-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="40" fill="rgba(255,255,255,0.05)"/></svg>');
            opacity: 0.3;
        }

        .hero-content {
            position: relative;
            z-index: 1;
        }

        .video-section iframe {
            display: block;
            width: 100%;
            aspect-ratio: 16/9;
            border: none;
        }

        .program-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 12px;
            backdrop-filter: blur(10px);
            letter-spacing: 0.5px;
        }

        h1 {
            font-size: 26px;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 14px;
        }

        .subtitle {
            font-size: 17px;
            font-weight: 500;
            opacity: 0.95;
            margin-bottom: 10px;
        }

        .subtitle-description {
            font-size: 14px;
            line-height: 1.5;
            opacity: 0.9;
        }

        /* Stats Card - mobile optimized */
        .stats-card {
            background: white;
            border-radius: 16px;
            padding: 16px;
            margin: -24px 16px 20px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            position: relative;
            z-index: 2;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            text-align: center;
        }

        .stat-item {
            padding: 10px 6px;
        }

        .stat-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 22px;
            font-weight: 700;
            color: #667eea;
        }

        /* Video Section - mobile optimized */
        .video-section {
            margin: 24px 0;
            background: #f8f9fa;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .video-placeholder {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            aspect-ratio: 16/9;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            position: relative;
            min-height: 200px;
        }

        .play-button {
            width: 70px;
            height: 70px;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: transform 0.2s;
            touch-action: manipulation;
        }

        .play-button:active {
            transform: scale(0.95);
        }

        .play-button::after {
            content: '';
            width: 0;
            height: 0;
            border-left: 20px solid white;
            border-top: 12px solid transparent;
            border-bottom: 12px solid transparent;
            margin-left: 5px;
        }

        .video-info {
            padding: 16px;
        }

        .video-title {
            font-size: 17px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 6px;
        }

        .video-meta {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
        }

        .video-description {
            font-size: 14px;
            color: #555;
            line-height: 1.5;
        }

        /* Overview Section */
        .overview-section {
            margin: 24px 0;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 14px;
        }

        .section-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: #1a1a1a;
        }

        .overview-text {
            font-size: 15px;
            color: #555;
            line-height: 1.6;
        }

        /* Content Cards - mobile optimized */
        .content-card {
            background: #f8f9fa;
            border-radius: 14px;
            padding: 18px 16px;
            margin: 20px 0;
            border-left: 4px solid #667eea;
        }

        .content-card h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-icon {
            font-size: 22px;
        }

        /* List Styles - touch-friendly */
        .content-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .content-list > li {
            position: relative;
            padding: 10px 0 10px 32px;
            font-size: 15px;
            color: #333;
            line-height: 1.6;
            margin-bottom: 4px;
        }

        .content-list > li::before {
            content: attr(data-icon);
            position: absolute;
            left: 0;
            top: 10px;
            width: 22px;
            height: 22px;
            background: rgba(102, 126, 234, 0.15);
            color: #667eea;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        /* Nested Lists - mobile spacing */
        .content-list ul {
            list-style: none;
            padding: 6px 0 6px 32px;
            margin: 0;
        }

        .content-list ul li {
            padding: 5px 0 5px 24px;
            font-size: 14px;
            color: #555;
            position: relative;
            line-height: 1.5;
        }

        .content-list ul li::before {
            content: attr(data-icon);
            position: absolute;
            left: 0;
            top: 5px;
            font-size: 15px;
        }

        .content-list ul ul {
            padding-left: 24px;
        }

        .content-list ul ul li {
            font-size: 13px;
            color: #666;
            padding: 4px 0 4px 22px;
        }

        .content-list ul ul li::before {
            font-size: 13px;
            top: 4px;
        }

        .content-list ul ul ul {
            padding-left: 20px;
        }

        .content-list ul ul ul li {
            font-size: 12px;
            color: #777;
            padding: 3px 0 3px 20px;
        }

        .content-list ul ul ul li::before {
            font-size: 12px;
            top: 3px;
        }

        /* Success Card - mobile optimized */
        .success-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 14px;
            padding: 18px 16px;
            margin: 24px 0;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .success-card h3 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .success-card .content-list > li::before {
            background: rgba(255,255,255,0.25);
            color: white;
        }

        .success-card .content-list > li {
            color: white;
        }

        /* Closing Note - mobile optimized */
        .closing-note {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            border-radius: 12px;
            padding: 16px;
            margin: 24px 0;
        }

        .closing-note p {
            font-size: 14px;
            color: #1565c0;
            line-height: 1.6;
            margin: 0;
        }

        /* Loading & Error States */
        .loading, .error-content {
            text-align: center;
            padding: 60px 20px;
        }

        .loading-spinner {
            font-size: 48px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Error Styling */
        .error-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .error-title {
            font-size: 22px;
            font-weight: 600;
            color: #FF3B30;
            margin-bottom: 12px;
        }

        .error-message {
            font-size: 16px;
            color: #666;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .error-details {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 12px;
            padding: 16px;
            text-align: left;
            margin: 20px 16px;
        }

        .error-details h4 {
            font-size: 15px;
            color: #856404;
            margin-bottom: 10px;
        }

        .error-details p {
            font-size: 14px;
            color: #856404;
            margin-bottom: 6px;
            line-height: 1.5;
        }

        /* Smooth scrolling on mobile */
        html {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        /* Prevent text size adjustment on orientation change */
        html {
            -webkit-text-size-adjust: 100%;
        }

        /* Better touch targets (minimum 44x44px) */
        button, .play-button {
            min-width: 44px;
            min-height: 44px;
        }

        /* Small phone optimizations */
        @media (max-width: 375px) {
            h1 {
                font-size: 24px;
            }

            .subtitle {
                font-size: 16px;
            }

            .stat-value {
                font-size: 20px;
            }

            .content-list > li {
                font-size: 14px;
            }

            .content-list ul li {
                font-size: 13px;
            }
        }

        /* Very small phones */
        @media (max-width: 320px) {
            .content-wrapper {
                padding: 16px 12px;
            }

            .stats-grid {
                gap: 8px;
            }

            .stat-label {
                font-size: 10px;
            }

            .stat-value {
                font-size: 18px;
            }
        }

        /* Activity Graph Styles */
        .activity-graph-section {
            background: white;
            border-radius: 16px;
            padding: 20px 16px;
            margin: 20px 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .activity-graph-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .activity-graph-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .activity-graph-title {
            font-size: 18px;
            font-weight: 700;
            color: #1a1a1a;
        }

        .activity-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 180px;
            gap: 4px;
            margin: 20px 0;
            position: relative;
        }

        .activity-chart::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: #e0e0e0;
        }

        .y-axis {
            position: absolute;
            top: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-size: 10px;
            color: #999;
            pointer-events: none;
        }

        .y-axis-left {
            left: -35px;
            align-items: flex-end;
        }

        .y-axis-right {
            right: -35px;
            align-items: flex-start;
        }

        .y-axis-label {
            line-height: 1;
        }

        .activity-day {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .activity-bars {
            display: flex;
            gap: 2px;
            align-items: flex-end;
            height: 140px;
            width: 100%;
            justify-content: center;
        }

        .activity-bar {
            flex: 1;
            max-width: 16px;
            border-radius: 4px 4px 0 0;
            transition: opacity 0.2s;
            position: relative;
        }

        .steps-bar {
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
        }

        .exercise-bar {
            background: linear-gradient(180deg, #f093fb 0%, #f5576c 100%);
        }

        .activity-day-label {
            font-size: 11px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            margin-top: 4px;
        }

        .activity-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e0e0e0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #666;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .legend-steps {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .legend-exercise {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .activity-loading {
            text-align: center;
            padding: 40px 20px;
            color: #666;
            font-size: 14px;
        }

        .activity-empty {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            font-size: 14px;
        }

        /* Safe area handling for notched devices */
        @supports (padding: max(0px)) {
            .hero-header {
                padding-top: max(32px, env(safe-area-inset-top));
            }

            .content-wrapper {
                padding-left: max(16px, env(safe-area-inset-left));
                padding-right: max(16px, env(safe-area-inset-right));
                padding-bottom: max(20px, env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <div id="contentContainer">
            <div class="loading">
                <div class="loading-spinner">‚è≥</div>
                <p>Loading content...</p>
            </div>
        </div>
    </div>

    <script>
        // Convert level number to fun label
        function getLevelLabel(level) {
            const labels = {
                1: 'Just Starting',
                2: 'Making Moves',
                3: 'Master',
                4: 'Super Master'
            };
            return labels[level] || `Level ${level}`;
        }

        // Parse plan parameter into program, level, module
        function parsePlanParameter(planString) {
            if (!planString) return null;
            
            const programMap = {
                'mindfulness': 'Mindfulness',
                'mindset': 'Mindfulness',
                'exercise': 'Movement',
                'movement': 'Movement',
                'sleep': 'Sleep'
            };
            
            const weekToModuleMap = {
                '1-4': 1,
                '5-8': 2,
                '9-12': 3,
                '13': 4,
                '13+': 4
            };
            
            const match = planString.match(/^([a-zA-Z]+)_(\d+)\s*(?:Weeks?\s*([\d\-+]+))?/i);
            
            if (match) {
                const programKey = match[1].toLowerCase();
                const levelNum = parseInt(match[2]);
                const weekRange = match[3] || '1-4';
                
                const program = programMap[programKey];
                const module = weekToModuleMap[weekRange];
                
                if (program && levelNum >= 1 && levelNum <= 4 && module) {
                    return {
                        program: program,
                        level: levelNum,
                        module: module,
                        planName: planString
                    };
                }
            }
            
            return null;
        }

        function getURLParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            
            const plan = urlParams.get('plan');
            if (plan) {
                const parsed = parsePlanParameter(plan);
                if (parsed) {
                    parsed.user_id = urlParams.get('user_id') || 'guest';
                    return parsed;
                }
            }
            
            return {
                program: urlParams.get('program'),
                level: parseInt(urlParams.get('level')),
                module: parseInt(urlParams.get('module')),
                user_id: urlParams.get('user_id') || 'guest',
                planName: null
            };
        }

        function validateParameters(params) {
            const validPrograms = ['Movement', 'Mindfulness', 'Sleep'];
            const validLevels = [1, 2, 3, 4];
            const validModules = [1, 2, 3, 4];

            if (!validPrograms.includes(params.program)) {
                return { valid: false, error: 'Invalid program parameter' };
            }

            if (!validLevels.includes(params.level)) {
                return { valid: false, error: 'Invalid level parameter' };
            }

            if (!validModules.includes(params.module)) {
                return { valid: false, error: 'Invalid module parameter' };
            }

            return { valid: true };
        }

        function generateListItems(items, icon = '‚Ä¢', level = 1) {
            if (!items || items.length === 0) return '';
            
            let html = '<ul class="content-list">';
            
            items.forEach(item => {
                if (typeof item === 'string') {
                    html += `<li data-icon="${icon}">${item}</li>`;
                } else if (typeof item === 'object') {
                    const itemIcon = item.icon || icon;
                    const itemText = item.text || '';
                    const children = item.children || [];
                    
                    html += `<li data-icon="${itemIcon}">${itemText}`;
                    
                    if (children.length > 0) {
                        const childIcon = item.childIcon || itemIcon;
                        html += generateListItems(children, childIcon, level + 1);
                    }
                    
                    html += '</li>';
                }
            });
            
            html += '</ul>';
            return html;
        }

        function generateContentSections(sections) {
            if (!sections || sections.length === 0) return '';
            
            let html = '';
            
            sections.forEach(section => {
                const sectionIcon = section.icon || 'üìã';
                const isSuccess = section.title.includes('Success');
                const cardClass = isSuccess ? 'success-card' : 'content-card';
                
                html += `
                    <div class="${cardClass}">
                        <h3>
                            <span class="card-icon">${sectionIcon}</span>
                            ${section.title}
                        </h3>
                        ${section.description ? `<p style="margin-bottom: 16px; color: ${isSuccess ? 'rgba(255,255,255,0.9)' : '#555'}; font-size: 14px;">${section.description}</p>` : ''}
                        ${generateListItems(section.items, section.defaultIcon || '‚Ä¢')}
                    </div>
                `;
            });
            
            return html;
        }

        function generateContent(params, data) {
            const displayPlan = params.planName || `${params.program} Level ${params.level}`;
            const levelLabel = getLevelLabel(params.level);
            
            // Extract module name from subtitle
            let moduleName = data.subtitle || '';
            if (moduleName.includes(':')) {
                moduleName = moduleName.split(':')[1].trim();
            }
            
            // Check if video is a YouTube URL
            let videoEmbed = '';
            if (data.video && data.video.includes('youtube.com')) {
                // Extract video ID from various YouTube URL formats
                let videoId = '';
                if (data.video.includes('watch?v=')) {
                    videoId = data.video.split('watch?v=')[1].split('&')[0];
                } else if (data.video.includes('youtu.be/')) {
                    videoId = data.video.split('youtu.be/')[1].split('?')[0];
                }
                
                if (videoId) {
                    videoEmbed = `
                        <div class="video-section">
                            <div class="video-placeholder" onclick="loadVideo(this, '${videoId}')">
                                <div class="play-button"></div>
                            </div>
                            <div class="video-info">
                                <div class="video-title">Introduction Video</div>
                                <div class="video-meta">${params.program} ‚Ä¢ ${levelLabel} ‚Ä¢ Module ${params.module}</div>
                                <div class="video-description">${data.videoDescription || ''}</div>
                            </div>
                        </div>
                    `;
                }
            } else if (data.video) {
                // Fallback to placeholder with video title
                videoEmbed = `
                    <div class="video-section">
                        <div class="video-placeholder">
                            <div class="play-button"></div>
                        </div>
                        <div class="video-info">
                            <div class="video-title">${data.video}</div>
                            <div class="video-meta">${params.program} ‚Ä¢ ${levelLabel} ‚Ä¢ Module ${params.module}</div>
                            <div class="video-description">${data.videoDescription || ''}</div>
                        </div>
                    </div>
                `;
            }

            // Add activity graph for Movement program
            let activityGraph = '';
            if (params.program === 'Movement' && params.user_id && params.user_id !== 'guest') {
                activityGraph = `
                    <div class="activity-graph-section" id="activityGraphSection">
                        <div class="activity-graph-header">
                            <div class="activity-graph-icon">üìä</div>
                            <div class="activity-graph-title">7-Day Activity</div>
                        </div>
                        <div class="activity-loading">Loading your activity data...</div>
                    </div>
                `;
            }
            
            // Add sleep graph for Sleep program
            if (params.program === 'Sleep' && params.user_id && params.user_id !== 'guest') {
                activityGraph = `
                    <div class="activity-graph-section" id="activityGraphSection">
                        <div class="activity-graph-header">
                            <div class="activity-graph-icon">üò¥</div>
                            <div class="activity-graph-title">7-Day Sleep</div>
                        </div>
                        <div class="activity-loading">Loading your sleep data...</div>
                    </div>
                `;
            }
            
            const content = `
                <div class="hero-header">
                    <div class="hero-content">
                        <div class="program-badge">${params.program.toUpperCase()}</div>
                        <h1>${data.title}</h1>
                        <div class="subtitle">${data.subtitle || ''}</div>
                        <div class="subtitle-description">${data.subtitleDescription || ''}</div>
                    </div>
                </div>

                <div class="stats-card">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-label">Level</div>
                            <div class="stat-value" style="font-size: 16px; line-height: 1.2;">${levelLabel}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Module</div>
                            <div class="stat-value" style="font-size: 16px; line-height: 1.2;">${moduleName || `Module ${params.module}`}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Weeks</div>
                            <div class="stat-value">${(params.module - 1) * 4 + 1}-${params.module * 4}</div>
                        </div>
                    </div>
                </div>

                ${activityGraph}

                <div class="content-wrapper">
                    ${videoEmbed}

                    <div class="overview-section">
                        <div class="section-header">
                            <div class="section-icon">üìñ</div>
                            <h2 class="section-title">Overview</h2>
                        </div>
                        <div class="overview-text">${data.description}</div>
                    </div>

                    ${data.sections ? generateContentSections(data.sections) : ''}

                    ${data.closingNote ? `
                    <div class="closing-note">
                        <p>${data.closingNote}</p>
                    </div>
                    ` : ''}
                </div>
            `;
            
            return content;
        }

        // Add this new function after generateContent
        function loadVideo(placeholder, videoId) {
            const iframe = document.createElement('iframe');
            iframe.width = '100%';
            iframe.height = '315';
            iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
            iframe.frameBorder = '0';
            iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
            iframe.allowFullscreen = true;
            iframe.style.cssText = 'border-radius: 16px 16px 0 0; display: block; aspect-ratio: 16/9;';
            
            placeholder.parentNode.replaceChild(iframe, placeholder);
        }

        function generateErrorPage(params, errorMessage) {
            return `
                <div class="content-wrapper">
                    <div class="error-content">
                        <div class="error-icon">‚ö†Ô∏è</div>
                        <h1 class="error-title">Content Not Found</h1>
                        <p class="error-message">${errorMessage}</p>
                        
                        <div class="error-details">
                            <h4>Request Parameters:</h4>
                            <p><strong>Plan:</strong> ${params.planName || 'Not provided'}</p>
                            <p><strong>Program:</strong> ${params.program || 'Not provided'}</p>
                            <p><strong>Level:</strong> ${params.level || 'Not provided'}</p>
                            <p><strong>Module:</strong> ${params.module || 'Not provided'}</p>
                        </div>

                        <div class="error-details" style="background: #e3f2fd; border-color: #2196F3; margin-top: 16px;">
                            <h4>Valid Plan Formats:</h4>
                            <p><strong>Format:</strong> ?plan=Program_Level Weeks X-Y</p>
                            <p><strong>Example:</strong> ?plan=Mindset_1 Weeks 1-4</p>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadActivityData(userId) {
            try {
                const response = await fetch('/.netlify/functions/user-weight-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch activity data');
                }
                const result = await response.json();
                
                console.log('Activity data API response:', result);
                
                if (!result.success || !result.data) {
                    throw new Error('No activity data available');
                }

                console.log('Returning activity data:', result.data);
                return result.data;
            } catch (error) {
                console.error('Error loading activity data:', error);
                return null;
            }
        }

        function renderSleepGraph(data) {
            const section = document.getElementById('activityGraphSection');
            if (!section) return;

            console.log('renderSleepGraph received data:', data, 'Type:', typeof data, 'IsArray:', Array.isArray(data));

            // Ensure data is an array
            if (!Array.isArray(data)) {
                data = [];
            }

            // Get last 7 days of data
            const today = new Date();
            const last7Days = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                last7Days.push(date.toISOString().split('T')[0]);
            }

            // Find max sleep hours for scaling
            let maxSleep = 0;
            let hasData = false;

            last7Days.forEach(date => {
                const entry = data.find(d => d.date === date);
                if (entry && entry.sleep_hours > 0) {
                    hasData = true;
                    maxSleep = Math.max(maxSleep, entry.sleep_hours || 0);
                }
            });

            // Use 10 hours as default max for scaling
            maxSleep = Math.max(maxSleep, 10);

            const dayLabels = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            let chartHTML = '<div class="activity-chart">';
            
            last7Days.forEach((date, index) => {
                const entry = data.find(d => d.date === date);
                const sleepHours = entry?.sleep_hours || 0;
                
                const sleepHeight = (sleepHours / maxSleep) * 100;
                
                const dateObj = new Date(date + 'T12:00:00');
                const dayLabel = dayLabels[dateObj.getDay()];
                
                // Format sleep label: "7.5h" or empty if no data
                const sleepLabel = sleepHours > 0 
                    ? `<div style="font-size: 9px; color: #999; margin-bottom: 2px;">${sleepHours.toFixed(1)}h</div>` 
                    : '';
                
                chartHTML += `
                    <div class="activity-day">
                        ${sleepLabel}
                        <div class="activity-bars">
                            <div class="activity-bar" style="background: linear-gradient(180deg, #4facfe 0%, #00f2fe 100%); height: ${sleepHeight}%; min-height: 2px; opacity: ${sleepHours > 0 ? 1 : 0.2}; max-width: 32px;" title="${sleepHours} hours sleep"></div>
                        </div>
                        <div class="activity-day-label">${dayLabel}</div>
                    </div>
                `;
            });
            
            chartHTML += '</div>';

            // Add y-axis labels for sleep hours
            const yAxisHTML = `
                <div class="y-axis y-axis-left">
                    <div class="y-axis-label">${Math.round(maxSleep)}h</div>
                    <div class="y-axis-label">${Math.round(maxSleep * 0.5)}h</div>
                    <div class="y-axis-label">0h</div>
                </div>
            `;
            chartHTML = chartHTML.replace('</div>', yAxisHTML + '</div>');

            const noDataMessage = !hasData ? `
                <div style="text-align: center; color: #999; font-size: 13px; margin-top: 12px;">
                    No sleep data recorded in the last 7 days
                </div>
            ` : '';

            section.innerHTML = `
                <div class="activity-graph-header">
                    <div class="activity-graph-icon">üò¥</div>
                    <div class="activity-graph-title">7-Day Sleep</div>
                </div>
                ${chartHTML}
                <div class="activity-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);"></div>
                        <span>Sleep Hours</span>
                    </div>
                </div>
                ${noDataMessage}
            `;
        }

        function renderActivityGraph(data) {
            const section = document.getElementById('activityGraphSection');
            if (!section) return;

            console.log('renderActivityGraph received data:', data, 'Type:', typeof data, 'IsArray:', Array.isArray(data));

            // Ensure data is an array
            if (!Array.isArray(data)) {
                data = [];
            }

            // Get last 7 days of data
            const today = new Date();
            const last7Days = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                last7Days.push(date.toISOString().split('T')[0]);
            }

            // Find max values for scaling
            let maxSteps = 0;
            let maxExercise = 0;
            let hasData = false;

            last7Days.forEach(date => {
                const entry = data.find(d => d.date === date);
                if (entry) {
                    hasData = true;
                    maxSteps = Math.max(maxSteps, entry.steps || 0);
                    maxExercise = Math.max(maxExercise, entry.exercise_minutes || 0);
                }
            });

            // Use reasonable defaults if max is 0
            maxSteps = Math.max(maxSteps, 10000);
            maxExercise = Math.max(maxExercise, 60);

            const dayLabels = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            let chartHTML = '<div class="activity-chart">';
            
            last7Days.forEach((date, index) => {
                const entry = data.find(d => d.date === date);
                const steps = entry?.steps || 0;
                const exercise = entry?.exercise_minutes || 0;
                
                const stepsHeight = (steps / maxSteps) * 100;
                const exerciseHeight = (exercise / maxExercise) * 100;
                
                const dateObj = new Date(date + 'T12:00:00');
                const dayLabel = dayLabels[dateObj.getDay()];
                
                chartHTML += `
                    <div class="activity-day">
                        <div class="activity-bars">
                            <div class="activity-bar steps-bar" style="height: ${stepsHeight}%; min-height: 2px; opacity: ${steps > 0 ? 1 : 0.2};" title="${steps.toLocaleString()} steps"></div>
                            <div class="activity-bar exercise-bar" style="height: ${exerciseHeight}%; min-height: 2px; opacity: ${exercise > 0 ? 1 : 0.2};" title="${exercise} min exercise"></div>
                        </div>
                        <div class="activity-day-label">${dayLabel}</div>
                    </div>
                `;
            });
            
            chartHTML += '</div>';

            // Show message if no data at all
            const noDataMessage = !hasData ? `
                <div style="text-align: center; color: #999; font-size: 13px; margin-top: 12px;">
                    No activity recorded in the last 7 days
                </div>
            ` : '';

            section.innerHTML = `
                <div class="activity-graph-header">
                    <div class="activity-graph-icon">üìä</div>
                    <div class="activity-graph-title">7-Day Activity</div>
                </div>
                ${chartHTML}
                <div class="activity-legend">
                    <div class="legend-item">
                        <div class="legend-color legend-steps"></div>
                        <span>Steps</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-exercise"></div>
                        <span>Exercise (min)</span>
                    </div>
                </div>
                ${noDataMessage}
            `;
        }

        async function loadContent() {
            const params = getURLParameters();
            const validation = validateParameters(params);
            const container = document.getElementById('contentContainer');

            if (!validation.valid) {
                container.innerHTML = generateErrorPage(params, validation.error);
                return;
            }

            try {
                const contentFile = `content/${params.program}-${params.level}-${params.module}.json`;
                
                console.log('Loading content file:', contentFile);
                console.log('Parsed parameters:', params);
                
                const response = await fetch(contentFile);
                
                if (!response.ok) {
                    throw new Error(`Content file not found: ${contentFile}`);
                }

                const data = await response.json();
                console.log('Content loaded successfully:', data);
                
                container.innerHTML = generateContent(params, data);

                // Load activity graph for Movement program
                if (params.program === 'Movement' && params.user_id && params.user_id !== 'guest') {
                    const activityData = await loadActivityData(params.user_id);
                    renderActivityGraph(activityData || []);
                }
                
                // Load sleep graph for Sleep program
                if (params.program === 'Sleep' && params.user_id && params.user_id !== 'guest') {
                    const sleepData = await loadActivityData(params.user_id);
                    renderSleepGraph(sleepData || []);
                }

            } catch (error) {
                console.error('Error loading content:', error);
                container.innerHTML = generateErrorPage(
                    params, 
                    `Content not yet available for ${params.program} Level ${params.level}, Module ${params.module}`
                );
            }
        }

        document.addEventListener('DOMContentLoaded', loadContent);
    </script>
</body>
</html>