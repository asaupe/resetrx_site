<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Book Quest Appointment</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow-x: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: transparent;
            padding: 0;
        }

        .container {
            width: 100%;
            height: 100%;
            background: white;
            padding: 20px 16px;
            overflow-y: auto;
        }

        h1 {
            font-size: 24px;
            font-weight: 800;
            color: #1a1a1a;
            margin-bottom: 8px;
            line-height: 1.2;
        }

        .subtitle {
            font-size: 14px;
            color: #666;
            margin-bottom: 24px;
            line-height: 1.4;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 8px;
        }

        input[type="text"],
        select,
        input[type="date"],
        input[type="time"] {
            width: 100%;
            padding: 12px 16px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            color: #1a1a1a;
            transition: border-color 0.2s;
            -webkit-appearance: none;
            appearance: none;
        }

        input[type="text"]:focus,
        select:focus,
        input[type="date"]:focus,
        input[type="time"]:focus {
            outline: none;
            border-color: #3b82f6;
        }

        select {
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%23666' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 40px;
        }

        .location-list {
            max-height: 200px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-top: 8px;
        }

        .location-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .location-item:last-child {
            border-bottom: none;
        }

        .location-item:hover {
            background-color: #f8f9fa;
        }

        .location-item.selected {
            background-color: #e3f2fd;
            border-left: 4px solid #3b82f6;
        }

        .location-name {
            font-size: 14px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 2px;
        }

        .location-address {
            font-size: 12px;
            color: #666;
        }

        .location-distance {
            font-size: 11px;
            color: #3b82f6;
            margin-top: 2px;
        }

        .time-slots {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        .time-slot {
            padding: 10px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            color: #1a1a1a;
            cursor: pointer;
            transition: all 0.2s;
        }

        .time-slot:hover {
            border-color: #3b82f6;
        }

        .time-slot.selected {
            background-color: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }

        .time-slot.unavailable {
            opacity: 0.4;
            cursor: not-allowed;
            text-decoration: line-through;
        }

        .btn-primary {
            width: 100%;
            padding: 16px;
            font-size: 16px;
            font-weight: 700;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 24px;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-primary:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
        }

        .info-box {
            background: #f0f9ff;
            border-left: 4px solid #3b82f6;
            padding: 12px;
            border-radius: 8px;
            margin-top: 16px;
        }

        .info-box-title {
            font-size: 13px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 4px;
        }

        .info-box-text {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }

        .hidden {
            display: none;
        }

        /* Responsive adjustments */
        @media (min-width: 450px) {
            .container {
                max-width: 440px;
                margin: 0 auto;
                padding: 24px 20px;
            }
        }

        @media (max-width: 360px) {
            h1 {
                font-size: 20px;
            }

            .subtitle {
                font-size: 13px;
            }

            .container {
                padding: 16px 12px;
            }

            .time-slots {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Book Your Quest Appointment</h1>
        <p class="subtitle">Find a Quest location near you and schedule your visit</p>

        <!-- Step 1: Location -->
        <div class="form-group">
            <label for="zipcode">Enter Your ZIP Code</label>
            <input type="text" id="zipcode" placeholder="e.g., 94102" maxlength="5">
        </div>

        <div id="locationSection" class="hidden">
            <div class="form-group">
                <label>Select a Location</label>
                <div class="location-list" id="locationList">
                    <!-- Locations will be populated here -->
                </div>
            </div>
        </div>

        <!-- Step 2: Date -->
        <div id="dateSection" class="hidden">
            <div class="form-group">
                <label for="appointmentDate">Select Date</label>
                <input type="date" id="appointmentDate">
            </div>
        </div>

        <!-- Step 3: Time -->
        <div id="timeSection" class="hidden">
            <div class="form-group">
                <label>Select Time</label>
                <div class="time-slots" id="timeSlots">
                    <!-- Time slots will be populated here -->
                </div>
            </div>
        </div>

        <!-- Confirmation -->
        <div id="confirmSection" class="hidden">
            <div class="info-box">
                <div class="info-box-title">Appointment Summary</div>
                <div class="info-box-text" id="appointmentSummary"></div>
            </div>
        </div>

        <button class="btn-primary" id="actionBtn" disabled>Find Locations</button>
    </div>

    <script>
        // Configuration
        const API_BASE = '/.netlify/functions';
        
        // Get patient ID from URL parameter or use test default
        const urlParams = new URLSearchParams(window.location.search);
        const patientId = urlParams.get('patientId') || 'TEST10001'; // Default test patient ID

        // State
        let locations = [];
        let appointments = [];
        let selectedLocation = null;
        let selectedDate = null;
        let selectedTime = null;
        let currentOrderKey = null;
        
        // Temporary patient data (will be replaced with Suggestic data later)
        const tempPatientData = {
            id: 'TEST10001',
            firstName: 'Patient',
            lastName: 'Test',
            dob: '1985-06-15',
            sex: 'Male',
            street: '123 Main St',
            city: 'Chicago',
            state: 'Illinois',
            postalCode: '60642',
            phone: '312-555-0100',
            email: 'patient@example.com'
        };

        const zipcodeInput = document.getElementById('zipcode');
        const locationSection = document.getElementById('locationSection');
        const locationList = document.getElementById('locationList');
        const dateSection = document.getElementById('dateSection');
        const appointmentDate = document.getElementById('appointmentDate');
        const timeSection = document.getElementById('timeSection');
        const timeSlotsContainer = document.getElementById('timeSlots');
        const confirmSection = document.getElementById('confirmSection');
        const actionBtn = document.getElementById('actionBtn');
        const appointmentSummary = document.getElementById('appointmentSummary');

        // Set minimum date to today
        const today = new Date().toISOString().split('T')[0];
        appointmentDate.setAttribute('min', today);

        // ZIP code input handler
        zipcodeInput.addEventListener('input', (e) => {
            const value = e.target.value.replace(/\D/g, '');
            e.target.value = value;
            
            if (value.length === 5) {
                actionBtn.disabled = false;
                actionBtn.textContent = 'Find Locations';
            } else {
                actionBtn.disabled = true;
            }
        });

        // Action button handler
        actionBtn.addEventListener('click', () => {
            if (actionBtn.textContent === 'Find Locations') {
                loadLocations();
            } else if (actionBtn.textContent === 'Continue to Date Selection') {
                showDateSection();
            } else if (actionBtn.textContent === 'Continue to Time Selection') {
                showTimeSection();
            } else if (actionBtn.textContent === 'Confirm Appointment') {
                confirmAppointment();
            }
        });

        async function loadLocations() {
            const zipcode = zipcodeInput.value;
            
            // Show loading state
            actionBtn.disabled = true;
            actionBtn.textContent = 'Creating order...';
            locationList.innerHTML = '<div style="padding: 16px; text-align: center; color: #666;">Setting up your appointment...</div>';
            
            try {
                // Step 1: Create order if we don't have one
                if (!currentOrderKey) {
                    console.log('Creating order first...');
                    const orderResponse = await fetch(`${API_BASE}/create-order`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            orderKey: 'RX' + String(Date.now()).slice(-12), // 14 chars: RX + 12 digit timestamp
                            labAccount: '73946524',
                            patient: tempPatientData,
                            tests: [
                                { testCode: '899' }
                            ]
                        })
                    });
                    
                    const orderResult = await orderResponse.json();
                    
                    if (!orderResult.success) {
                        throw new Error('Failed to create order: ' + (orderResult.error || 'Unknown error'));
                    }
                    
                    currentOrderKey = orderResult.data.Order_Key;
                    console.log('Order created:', currentOrderKey);
                }
                
                // Step 2: Search for locations
                actionBtn.textContent = 'Finding locations...';
                console.log('Fetching locations for ZIP:', zipcode, 'Order Key:', currentOrderKey);
                
                const response = await fetch(`${API_BASE}/get-locations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        postalCode: zipcode,
                        patientId: tempPatientData.id,
                        orderKey: currentOrderKey,
                        radiusMiles: 50
                    })
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Response error:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                console.log('API result:', result);
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to load locations');
                }

                locations = result.data;
                
                // Display locations
                locationList.innerHTML = '';
                
                if (!locations || locations.length === 0) {
                    locationList.innerHTML = '<div style="padding: 16px; text-align: center; color: #666;">No locations found within 50 miles.</div>';
                    return;
                }

                locations.forEach(location => {
                    const item = document.createElement('div');
                    item.className = 'location-item';
                    
                    // Build address from KHSS response format
                    const address = `${location.address1 || ''}${location.address2 ? ', ' + location.address2 : ''}`;
                    const cityState = `${location.city || ''}, ${location.state || ''} ${location.postalCode || ''}`;
                    
                    item.innerHTML = `
                        <div class="location-name">${location.name || 'Quest Diagnostics'}</div>
                        <div class="location-address">${address}<br>${cityState}</div>
                        <div class="location-distance">${location.phone || ''}</div>
                    `;
                    item.addEventListener('click', () => selectLocation(location, item));
                    locationList.appendChild(item);
                });
                
                locationSection.classList.remove('hidden');
                actionBtn.textContent = 'Continue to Date Selection';
            } catch (error) {
                console.error('Error loading locations:', error);
                
                let errorMessage = error.message;
                if (error.message === 'fetch failed' || error.message.includes('Failed to fetch')) {
                    errorMessage = 'Cannot connect to server. Make sure you are running "netlify dev" in the terminal.';
                }
                
                locationList.innerHTML = `<div style="padding: 16px; text-align: center; color: #dc2626;">
                    <strong>Error:</strong> ${errorMessage}<br><br>
                    <small>Check the browser console for more details.</small>
                </div>`;
                actionBtn.textContent = 'Find Locations';
                actionBtn.disabled = false;
            }
        }

        function selectLocation(location, element) {
            document.querySelectorAll('.location-item').forEach(item => {
                item.classList.remove('selected');
            });
            element.classList.add('selected');
            selectedLocation = location;
            
            // Clear previous date and time selections when changing location
            selectedDate = null;
            selectedTime = null;
            appointmentDate.value = '';
            
            // Hide and reset date/time sections
            dateSection.classList.add('hidden');
            timeSection.classList.add('hidden');
            confirmSection.classList.add('hidden');
            timeSlotsContainer.innerHTML = '';
            
            // Reset button to date selection state
            actionBtn.disabled = false;
            actionBtn.textContent = 'Continue to Date Selection';
        }

        function showDateSection() {
            dateSection.classList.remove('hidden');
            actionBtn.disabled = true;
            actionBtn.textContent = 'Continue to Time Selection';
        }

        appointmentDate.addEventListener('change', async (e) => {
            selectedDate = e.target.value;
            if (selectedDate) {
                // Automatically reload times when date changes
                await showTimeSection();
            } else {
                actionBtn.disabled = true;
            }
        });

        async function showTimeSection() {
            timeSlotsContainer.innerHTML = '<div style="padding: 16px; text-align: center; color: #666;">Loading available times...</div>';
            timeSection.classList.remove('hidden');
            actionBtn.disabled = true;
            actionBtn.textContent = 'Loading...';
            
            try {
                // Get appointments for the week starting from selected date
                const fromDate = new Date(selectedDate);
                const toDate = new Date(selectedDate);
                toDate.setDate(toDate.getDate() + 7);
                
                const response = await fetch(`${API_BASE}/get-appointments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        siteCode: selectedLocation.siteCode,
                        patientId: tempPatientData.id,
                        orderKey: currentOrderKey,
                        fromDate: fromDate.toISOString().split('T')[0],
                        toDate: toDate.toISOString().split('T')[0],
                        firstAvailable: false
                    })
                });

                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to load appointments');
                }

                appointments = result.data;
                console.log('Appointments received:', appointments);
                
                // Display time slots
                timeSlotsContainer.innerHTML = '';
                
                // KHSS returns nested structure: appointments contains days, each with locations array
                let timeSlots = [];
                
                if (Array.isArray(appointments)) {
                    // Find appointments for the selected date
                    const dayData = appointments.find(apt => apt.day === selectedDate);
                    
                    if (dayData && dayData.locations && dayData.locations.length > 0) {
                        // Get appointments from first location
                        timeSlots = dayData.locations[0].appointments || [];
                    }
                }
                
                console.log('Time slots extracted:', timeSlots);
                
                if (timeSlots.length === 0) {
                    timeSlotsContainer.innerHTML = '<div style="padding: 16px; text-align: center; color: #666;">No appointments available for this date.</div>';
                    actionBtn.textContent = 'Confirm Appointment';
                    return;
                }

                // Display available times
                timeSlots.forEach((apt, idx) => {
                    console.log(`Time slot ${idx}:`, apt);
                    const slot = document.createElement('div');
                    slot.className = 'time-slot';
                    
                    // Use the pre-formatted time string from KHSS
                    slot.textContent = apt.apptTimeString?.trim() || 
                                      formatAppointmentTime(apt);
                    
                    slot.addEventListener('click', () => selectTime(apt, slot));
                    timeSlotsContainer.appendChild(slot);
                });
                
                actionBtn.textContent = 'Confirm Appointment';
            } catch (error) {
                console.error('Error loading appointments:', error);
                timeSlotsContainer.innerHTML = `<div style="padding: 16px; text-align: center; color: #dc2626;">Error: ${error.message}</div>`;
                actionBtn.textContent = 'Confirm Appointment';
            }
        }

        function formatAppointmentTime(apt) {
            // KHSS format: apptStartHour and apptStartMin (primary format)
            if (apt.apptStartHour !== undefined && apt.apptStartMin !== undefined) {
                let hour = apt.apptStartHour;
                const min = String(apt.apptStartMin).padStart(2, '0');
                const period = hour >= 12 ? 'pm' : 'am';
                
                // Convert 24-hour to 12-hour format
                if (hour > 12) hour -= 12;
                if (hour === 0) hour = 12;
                
                return `${hour}:${min}${period}`;
            }
            
            // Format 1: Direct time string (including apptTimeString)
            if (apt.time || apt.Time || apt.Slot_Time || apt.apptTimeString) {
                return (apt.time || apt.Time || apt.Slot_Time || apt.apptTimeString).trim();
            }
            
            // Format 2: hour and min fields (numeric)
            if ((apt.hour !== undefined && apt.min !== undefined) ||
                (apt.Hour !== undefined && apt.Min !== undefined)) {
                const hour = parseInt(apt.hour || apt.Hour);
                const min = parseInt(apt.min || apt.Min);
                const period = hour >= 12 ? 'PM' : 'AM';
                const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
                return `${displayHour}:${min.toString().padStart(2, '0')} ${period}`;
            }
            
            // Format 3: hour and min as strings
            if ((apt.hour && typeof apt.hour === 'string') || 
                (apt.Hour && typeof apt.Hour === 'string')) {
                const hourStr = apt.hour || apt.Hour;
                const minStr = apt.min || apt.Min || '0';
                const hour = parseInt(hourStr);
                const min = parseInt(minStr);
                const period = hour >= 12 ? 'PM' : 'AM';
                const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
                return `${displayHour}:${min.toString().padStart(2, '0')} ${period}`;
            }
            
            // Format 4: Combined datetime field
            if (apt.datetime || apt.DateTime || apt.slot_datetime) {
                const dt = new Date(apt.datetime || apt.DateTime || apt.slot_datetime);
                const hour = dt.getHours();
                const min = dt.getMinutes();
                const period = hour >= 12 ? 'PM' : 'AM';
                const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
                return `${displayHour}:${min.toString().padStart(2, '0')} ${period}`;
            }
            
            // Fallback: show raw object for debugging
            console.warn('Unable to parse appointment time:', apt);
            return JSON.stringify(apt);
        }

        function selectTime(appointment, element) {
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.classList.remove('selected');
            });
            element.classList.add('selected');
            selectedTime = appointment;
            
            // Show summary
            const date = new Date(selectedDate);
            const dateStr = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
            const timeStr = formatAppointmentTime(appointment);
            
            const address = `${selectedLocation.address1 || ''}${selectedLocation.address2 ? ', ' + selectedLocation.address2 : ''}`;
            const cityState = `${selectedLocation.city || ''}, ${selectedLocation.state || ''} ${selectedLocation.postalCode || ''}`;
            
            appointmentSummary.innerHTML = `
                <strong>${selectedLocation.name || 'Quest Diagnostics'}</strong><br>
                ${address}<br>
                ${cityState}<br><br>
                <strong>${dateStr}</strong><br>
                ${timeStr}
            `;
            
            confirmSection.classList.remove('hidden');
            actionBtn.disabled = false;
        }

        async function confirmAppointment() {
            actionBtn.disabled = true;
            actionBtn.textContent = 'Booking...';
            
            try {
                const response = await fetch(`${API_BASE}/set-appointment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        patientId: tempPatientData.id,
                        orderKey: currentOrderKey,
                        siteCode: selectedLocation.siteCode,
                        day: selectedDate,
                        hour: selectedTime.apptStartHour || selectedTime.hour || 0,
                        min: selectedTime.apptStartMin || selectedTime.min || 0
                    })
                });

                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to book appointment');
                }

                // Show success message with countdown
                let countdown = 10;
                actionBtn.style.display = 'none'; // Hide the button
                
                appointmentSummary.innerHTML = `
                    <div style="text-align: center; color: #059669; padding: 20px;">
                        <h3>âœ… Appointment Confirmed!</h3>
                        <p>Confirmation Number: ${result.data.confirmationNumber || 'Pending'}</p>
                        <p style="color: #666; margin-top: 10px;">You will receive a confirmation email shortly.</p>
                        <p style="color: #059669; margin-top: 20px; font-weight: bold;">Redirecting in <span id="countdown">${countdown}</span> seconds...</p>
                    </div>
                `;
                
                // Countdown timer
                const countdownInterval = setInterval(() => {
                    countdown--;
                    const countdownEl = document.getElementById('countdown');
                    if (countdownEl) {
                        countdownEl.textContent = countdown;
                    }
                    
                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                        window.location.href = 'https://asaupe.github.io/resetrx_site/html_files/week_1_day_1.html';
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Error confirming appointment:', error);
                alert(`Error booking appointment: ${error.message}`);
                actionBtn.textContent = 'Confirm Appointment';
                actionBtn.disabled = false;
            }
        }
    </script>
</body>
</html>